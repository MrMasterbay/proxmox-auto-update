--------------

`# Proxmox Autoâ€‘Update Script    A small, selfâ€‘contained Bash utility that safely updates a Proxmox node (Debianâ€¯13 base) and notifies you by eâ€‘mail. It:   * Prevents concurrent executions with a lock file. * Installs **`needrestart`** automatically if it isn't present. * Runs `apt update`, `apt full-upgrade`, `apt autoremove` and `apt clean`. * Checks for a required reboot in **two** ways:   1.  `needs-restarting -r` (only reported when a reboot is actually needed).   2. The classic Debian flag file `/var/run/rebootâ€‘required`. * Writes a detailed log to `/var/log/proxmox-auto-update.log`. * Sends a concise eâ€‘mail whose **subject line** already tells you whether a reboot is required.   >  **Important:** The script never reboots the host automatically -- you decide when to restart.   ---    ## Table of Contents    -  [Prerequisites](#prerequisites)  -  [Installation](#installation)  -  [Configuration](#configuration)  -  [Running the script manually](#running-the-script-manually)  -  [Scheduling with cron](#scheduling-with-cron)  -  [Log files](#log-files)  -  [Troubleshooting](#troubleshooting)  -  [License](#license)    ---    ## Prerequisites    | Requirement | Why it's needed |  |-------------|-----------------|  |  **Root / sudo privileges**  | The script manipulates the package manager and writes to system directories. |  |  **`mail` (or compatible MTA)**  | Used to send the notification eâ€‘mail. Most Proxmox installations already have `postfix` or `exim4`. |  |  **Internet connectivity**  | To fetch package lists and install `needrestart` if missing. |  |  **Bash â‰¥â€¯4** (standard on Debianâ€¯13) | The script uses Bashâ€‘specific features (`set -euo pipefail`). |    ---    ## Installation    1.  **Copy the script to the target host** (e.g. via `scp` or a configurationâ€‘management tool).   ```bash sudo cp proxmox-auto-update.sh /usr/local/sbin/ sudo chmod +x /usr/local/sbin/proxmox-auto-update.sh`

1.  **Verify the script runs without errors** (a log file will be created).

    `sudo /usr/local/sbin/proxmox-auto-update.sh`

2.  **Check the log** to confirm everything succeeded:

    `cat /var/log/proxmox-auto-update.log`

* * * * *

Configuration
-------------

All configurable values are defined near the top of the script:

`HOSTNAME="$(hostname -f)"  # FQDN of the node  LOCKFILE="/var/run/proxmox-auto-update.lock"  LOGFILE="/var/log/proxmox-auto-update.log"  MAIL_TO="root@localhost"  # Change to the address you want notifications sent to  APTCMD="/usr/bin/apt-get"  NEEDRESTART_PKG="needrestart"  NEEDRESTART_CMD="/usr/sbin/needs-restarting"`

*Adjust `MAIL_TO`* to point to a real mailbox (e.g. `admin@example.com`).\
If you prefer a different log location, modify `LOGFILE` and `LOCKFILE` accordingly.

* * * * *

Running the script manually
---------------------------

`sudo /usr/local/sbin/proxmox-auto-update.sh`

The script will:

1.  Acquire a lock (prevents parallel runs).
2.  Install `needrestart` if it isn't already present.
3.  Perform the full upgrade cycle.
4.  Determine whether a reboot is required.
5.  Write a detailed log.
6.  Send an eâ€‘mail whose subject already says **"Reboot required"** or **"No reboot needed."**

* * * * *

Scheduling with cron
--------------------

To run the script automatically **every Sunday at midnight**, add the following line to root's crontab:

`0 0 * * 0 /usr/local/sbin/proxmox-auto-update.sh >> /var/log/proxmox-auto-update-cron.log 2>&1`

**Steps**

`sudo  crontab -e # open root's crontab  # paste the line above, save and quit  sudo  crontab -l # verify the entry`

The extra redirection (`>> ... 2>&1`) captures any output that cron itself produces, separate from the script's own log.

* * * * *

Log files
---------

| File | Purpose |
| --- | --- |
| `/var/log/proxmox-auto-update.log` | Main script log -- contains timestamps, package actions, and the rebootâ€‘status summary. |
| `/var/log/proxmox-auto-update-cron.log` | Output generated by cron (mostly useful for diagnosing cronâ€‘related issues). |

Both logs are rotated automatically by most default `logrotate` configurations, but you can add a custom rule under `/etc/logrotate.d/` if you need tighter control.

* * * * *

Troubleshooting
---------------

| Symptom | Likely cause | Fix |
| --- | --- | --- |
| No eâ€‘mail arrives | No MTA installed or `MAIL_TO` points to a nonâ€‘existent mailbox. | Install `postfix`/`exim4` (`apt install postfix`) and verify local delivery (`mail -s test root`). |
| Script aborts with "permission denied" | Not executed as root. | Run with `sudo` or place the script in a directory owned by root (`/usr/local/sbin`). |
| `needs-restarting` not found after first run | `needrestart` failed to install (maybe network issue). | Manually install: `apt install needrestart`. |
| Cron never runs | Wrong crontab syntax or cron service stopped. | Verify with `systemctl status cron` and `crontab -l`. |
| Log file empty | Script never reached the logging section (early failure). | Run the script manually to see the error output. |

* * * * *

### Quick reference cheatâ€‘sheet

`# Install script  sudo  cp proxmox-auto-update.sh /usr/local/sbin/ sudo  chmod +x /usr/local/sbin/proxmox-auto-update.sh   # Manual run  sudo /usr/local/sbin/proxmox-auto-update.sh   # Add to cron (run Sundays at 00:00)  sudo  crontab -e # â†’ paste:  0  0 * * 0 /usr/local/sbin/proxmox-auto-update.sh >> /var/log/proxmox-auto-update-cron.log 2>&1`

That's it! Your Proxmox node will stay upâ€‘toâ€‘date, and you'll always know whether a reboot is required---right from the eâ€‘mail subject line. ðŸŽ‰

* * * * *

*Happy automating!*

`  ---   ## ðŸ“„ `crontab.txt` (optional -- for easy copyâ€‘paste)   
If you prefer to keep the cron entry in a separate file, you can add this file to the repo and install it with `crontab crontab.txt`.  
 ```cron # Run the Proxmox autoâ€‘update script every Sunday at midnight 0 0 * * 0 /usr/local/sbin/proxmox-auto-update.sh >> /var/log/proxmox-auto-update-cron.log 2>&1`

You can apply it with:

`sudo  crontab crontab.txt`

* * * * *

Feel free to drop these files into your repository, adjust the `MAIL_TO` address, and you're good to go!
